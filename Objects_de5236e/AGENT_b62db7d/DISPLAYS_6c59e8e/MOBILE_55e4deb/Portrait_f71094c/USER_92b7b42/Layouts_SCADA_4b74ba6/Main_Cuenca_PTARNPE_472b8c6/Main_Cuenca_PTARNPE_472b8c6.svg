<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="1100" version="1.2" width="644" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="5" width="5"/>
 </metadata>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[//----------------Inicializo variables -------------------//


//Variable interna
var Info_Windowact=false;
var Markeract=false;
var Markeractdc;
var Markers= new Array();
var Rutas= new Array();
var Pos_origen;
var Pos_destination;
var WayPoints = new Array();

var google = webMI.rootWindow.google; //Clase Principal
var map; //Variable donde va a vivir el mapa
var m,n;
var circuito =
	[[21.137170400189998, -86.92098834822414],				
	 [21.141268641653536, -86.90480579616154],
	 [21.14128142495474, -86.8981065114646],	
	 [21.153443715839963, -86.88558830323406],	 
	 [21.15689142838811, -86.89918766741306],	 	 
	 [21.163703500523773, -86.91392151418717],	 	 
	 [21.171519679486227, -86.9041667302432],	 	 
	 [21.17055747597586, -86.87896273160592],	 	 
	 [21.193558916751513, -86.87174585244826],	 	  
	 [21.187849356182213, -86.87511644805177],	 	 
	 [21.179728208567866, -86.89379704204964],
	 [21.179906188278824, -86.89371214107973]]

					
var circuito_s =
	[[{lat:21.137170400189998, lng:-86.92098834822414},
	"Cárcamo Paraíso Maya, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Paraiso_Maya",
	1, "carcamoAR"],
	[{lat:21.141268641653536, lng:-86.90480579616154},
	"Cárcamo Tierra Maya, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Tierra_Maya",
	2, "carcamoAR"],
	[{lat:21.14128142495474, lng:-86.8981065114646},
	"Cárcamo Linda Vista, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Linda_Vista",
	3, "carcamoAR"],
	[{lat:21.153443715839963, lng:-86.88558830323406},
	"Cárcamo R 102, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_R102",
	4, "carcamoAR"],
	[{lat:21.15689142838811, lng:-86.89918766741306},
	"Cárcamo ARA, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_ARA",
	5, "carcamoAR"],
	[{lat:21.163703500523773, lng:-86.91392151418717},
	"Cárcamo Polígono Paraíso, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Poligono_Paraiso",
	6, "carcamoAR"],
	[{lat:21.171519679486227, lng:-86.9041667302432},
	"Cárcamo Paseos del Mar, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Paseos_del_Mar",
	7, "carcamoAR"],
	[{lat:21.17055747597586, lng:-86.87896273160592},
	"Cárcamo Guadalupana, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Guadalupana",
	7, "carcamoAR"],
	[{lat:21.193558916751513, lng:-86.87174585244826},
	"Cárcamo Villas del Mar, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Villas_del_Mar",
	7, "carcamoAR"],
	[{lat:21.187849356182213, lng:-86.87511644805177},
	"Cárcamo Casas del Mar, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Casas_del_Mar",
	7, "carcamoAR"],
	[{lat:21.179728208567866, lng:-86.89379704204964},
	"Cárcamo Final Norponiente, Agua Residual",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Final_Norponiente",
	7, "carcamoAR"],
	[{lat:21.179373899815154, lng:-86.89465893421475},
	"Pretratamiento PTAR Norponiente",
	"AGENT.OBJECTS.SCADA.Benito_Juarez.Cuencas.Cuenca_CAR_NPE.Carcamo_Final_Norponiente",
	7, "ptar"]];
					
var infowindow;					
var circuito_centro;
var carcamoAR = "/icons/carcamo_ar_30_18px.png";



//----------------Ejecución -------------------//



//Determinación del dispositivo
var infoCliente;
infoCliente = new webMI.getClientInfo();

//Preprocesamiento de variables

//Calculo del Centro
var suma=[0,0];
for (var i=0; i<circuito.length; i++){
	suma[0]=suma[0]+circuito[i][0]; //Latitud 
	suma[1]=suma[1]+circuito[i][1]; //Longitud
}

circuito_centro=[suma[0]/circuito.length,suma[1]/circuito.length];


webMI.addOnload(function() {
	
	//Posiciones en el mapa
	var position1 = new google.maps.LatLng(circuito_centro[0], circuito_centro[1]);
	
	//Opciones del mapa
	var myOptions = {
		zoom: 13,
		center: position1,
		mapTypeId: google.maps.MapTypeId.roadmap
	};
	

	//Inicializo el mapa
	map = new google.maps.Map(document.getElementById("mapa"), myOptions);
	
	
		
	
		
	// Instantiate an info window to hold step text.
	const stepDisplay = new google.maps.InfoWindow();
	
	
	//-------Inicializo Marcadores
	
	circuito_s.forEach(([position,title,object,order,type],i) =>{
	if (type == 'ptar') {
	carcamoAR = "/icons/planta.png"
	}
	
	
		const marker = new google.maps.Marker({
			position, 
			map,
			icon: carcamoAR,
			title: ` ${order}`,
			optimized: false,
		});
		
		marker.setMap(map);
		
		//Agrego marcador a lista de marcadores
		Markers.push(marker);
	
		//-------Listener de Marcadores
		
		//DOBLECLICK (Fija Carcamo)
		google.maps.event.addListener(marker,'dblclick',function(event) {
							
			//Abrir display en frame de la izquierda, en la primera posición, relativo a la base		
			//webMI.display.openDisplay("ObjectTypes.PROJECT.ElementoLineaAR.Tanque",
			//{base:   object}, "topologia");			
			map.panTo(this.getPosition());
			map.setZoom(16.5);
			webMI.display.openDisplay( object + ".Control",
			webMI.query, "topologia");
			

			Markeract=true;
			Markeractdc=marker;
			Pos_origen=position;
		
			
			//Limpio
			Elimina_Ruta(Rutas);
				
		});
	/*	map.addListener("zoom_changed", () => {
    infowindow.setContent("Zoom: " + map.getZoom());
  });*/
		
		
		//CLICK (Abre Infowindow)
		google.maps.event.addListener(marker,'click',function(event) {	
			
			//Abro en temporal
			if (marker!=Markeractdc && Markeract==true ){		
				Pos_destination=position;	
				
				//Limpio
				Elimina_Ruta(Rutas);
				
				//Dibujo
				Dibuja_Ruta(Pos_origen,Pos_destination);
			}
			
			
		});	
			
		
		//MOUSEOVER
		google.maps.event.addListener(marker, "mouseover", function(event){
			infowindow = new google.maps.InfoWindow();
			//Abro marcador
			infowindow.open(marker.getMap,marker);
			Info_Windowact=true;
			//Defino que objeto va a ser el seleccionado para mostrar su información
			webMI.data.subscribe( object +".level_percent",
			function(e){
				infowindow.setContent(title+" - Nivel: " +
				e.value.toFixed(2) + "%");
				}
			);
			
				//infowindow.setContent(title);
		
		});	
		
		//MOUSEOUT
		google.maps.event.addListener(marker, "mouseout", function(event){
			
			
			if (Info_Windowact){
				infowindow.close();
				Info_Windowact=false;
			}			
		});
		
		
		
	});	
			
});



function Dibuja_Ruta(Origen,Destination){
	
	if(Markeract && (Origen!=Destination)){
			
		//////////// Servicios Rutas en el mapa
		var directionsService = new google.maps.DirectionsService();
		var directionsRenderer = new google.maps.DirectionsRenderer({ map: map });		
		
		//Crea el request
		var request = {
			origin: Origen,
			destination:Destination,
			travelMode: google.maps.TravelMode.DRIVING // Puedes ajustar el modo de transporte según tus necesidades
		  };    
		
		
		directionsService.route(request, function(response, status) {
			if (status == google.maps.DirectionsStatus.OK) {
			  directionsRenderer.setDirections(response);
			  Rutas.push(directionsRenderer);
			}
		  });
	 }
    
 }


function Elimina_Ruta(Rutas){
	
	Rutas.forEach(function(ruta) {
		ruta.setMap(null);
	});
	
	Rutas=new Array();
    
 }
]]></script>
 <svg atv:refpx="325.624" atv:refpy="145.225" height="600" id="topologia" transform="matrix(0.8063,0,0,0.6833,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="0">
  <atv:argument name="display" value="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.Layouts_SCADA.Cuencas.Cuenca_NPE"/>
  <atv:argument name="isNavigationFrame" value="true"/>
 </svg>
 <svg atv:refpx="322.014" atv:refpy="717.653" height="600" id="circuito_2" transform="matrix(0.805,0,0,1.025,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="399.999">
  <atv:argument name="isNavigationFrame" value="true"/>
  <atv:argument name="frameName" value="grafica"/>
  <atv:argument name="display" value="AGENT.DISPLAYS.MOBILE.Portrait.USER.Layouts_SCADA.Cuencas.Graficas.Grafica_NPE"/>
 </svg>
 <svg atv:refpx="321.993" atv:refpy="1062.459" height="300" id="id_3" transform="matrix(1.995,0,0,0.25,0,0)" width="200" x="61.404" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.navigation" y="4100">
  <atv:overwrite id="navigation_description" transform="matrix(1.2903,0,0,0.3429,0,0)"/>
  <atv:argument name="navPanelAlign" value="bottom"/>
  <atv:overwrite id="navigation_1_description" transform="matrix(1.25,0,0,0.3371,0,0)"/>
  <atv:argument name="navContainerID" value="navigation_4"/>
  <atv:argument name="navHomeDisplay" value="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.Layouts_SCADA.Main"/>
  <atv:argument name="navItemCount" value="2"/>
  <atv:argument name="navAnimateFactor" value="3"/>
  <atv:argument name="navPanelBorderColor" value="SYSTEM.GLOBALS."/>
  <atv:argument name="navItemBorderColor" value="SYSTEM.GLOBALS.#20dbd8"/>
  <atv:argument name="navItemBorderRadius" value="50"/>
  <atv:argument name="navItemWidthSteady" value="150"/>
  <atv:argument name="navItemIndentationActive" value="80"/>
  <atv:argument name="navFontSize" value="18"/>
  <atv:overwrite id="navigation_2_description" transform="matrix(0.2022,0,0,2.727,0,0)"/>
  <atv:argument name="navCustomEntry" prefix="base" value="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.Layouts_SCADA.Circuitos"/>
  <atv:argument name="navCustomTitle01" value="Gráfica 1"/>
  <atv:argument name="navCustomTitle02" value="Gráfica 2"/>
  <atv:argument name="navCustomDisplay01" value="AGENT.DISPLAYS.MOBILE.Portrait.USER.Layouts_SCADA.Cuencas.Graficas.Grafica_NPE"/>
  <atv:argument name="navCustomDisplay02" value="AGENT.DISPLAYS.MOBILE.Portrait.USER.Layouts_SCADA.Cuencas.Graficas.Grafica_NPE_2"/>
  <atv:argument name="navHomeText" value="Red Hidráulica"/>
  <atv:argument name="navIconHomeActive" value="false"/>
  <atv:argument name="navItemBackgroundActive" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color2"/>
  <atv:argument name="navArrowBackground" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color1"/>
  <atv:argument name="navHomeBackground" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color1"/>
  <atv:argument name="navItemBackgroundInactive" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color1"/>
  <atv:argument name="navItemBackgroundHover" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color3"/>
  <atv:argument name="navFontColorHover" value="SYSTEM.GLOBALS.Colors.Blanco"/>
  <atv:argument name="navFontColorInactive" value="SYSTEM.GLOBALS.Colors.Blanco"/>
  <atv:argument name="navFontColorActive" value="SYSTEM.GLOBALS.Colors.blue_vivid_palette.color5"/>
  <atv:argument name="navHomeColor" value="SYSTEM.GLOBALS.Colors.Blanco"/>
  <atv:argument name="navHomeActive" value="false"/>
  <atv:overwrite id="navigation_3_description" transform="matrix(0.3106,0,0,3.3333,0,0)"/>
  <atv:argument name="navArrowActive" value="false"/>
  <atv:argument name="navContent" value="grafica"/>
  <atv:overwrite id="navigation_4_description" transform="matrix(0.5013,0,0,4,0,0)"/>
 </svg>
</svg>
