<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="890" version="1.2" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter behavior="optional" defaultvalue="Nombre c치rcamo" desc="Nombre de la estaci칩n de rebombeo" name="pumping_station" substitute="$pumping_station$" valuetype="address"/>
  <atv:gridconfig enabled="true" gridstyle="lines" height="10" width="10"/>
  <atv:snapconfig enabled="true" height="5" width="5"/>
 </metadata>
 <rect atv:refpx="709.5" atv:refpy="169.203" fill="#ffffff" height="338.407" id="id_28" stroke="#000000" stroke-width="2" width="1419" x="0" y="0"/>
 <rect atv:refpx="1670.521" atv:refpy="170.203" fill="#ffffff" height="338.407" id="id_29" stroke="#000000" stroke-width="2" width="495" x="1423" y="1"/>
 <text atv:refpx="650.488" atv:refpy="157.572" fill="#000000" font-family="Arial" font-size="14" font-weight="bold" id="id_6" text-anchor="start" transform="matrix(1.377,0,0,1.2857,-215.644,-41.7122)" x="576" y="163">Informaci칩n de referencia</text>
 <text atv:refpx="574.058" atv:refpy="217.788" fill="#000000" font-family="Arial" font-size="14" id="id_8" text-anchor="start" transform="matrix(1.377,0,0,1.2857,-215.644,-57.6297)" x="577" y="218.714">Responsable: </text>
 <text atv:refpx="575.825" atv:refpy="239.788" fill="#000000" font-family="Arial" font-size="14" id="id_5" text-anchor="start" transform="matrix(1.377,0,0,1.2857,-215.644,-63.9151)" x="576.5" y="240.714">Responsable</text>
 <text atv:refpx="574.872" atv:refpy="265.788" fill="#000000" font-family="Arial" font-size="14" id="id_11" text-anchor="start" transform="matrix(1.377,0,0,1.2857,-214.8653,-71.3433)" x="575.434" y="266.714">Tel: 998 185 5431</text>
 <svg atv:refpx="1669.759" atv:refpy="167.479" height="600" id="id_12" transform="matrix(0.6125,0,0,0.5417,0,0)" width="800" x="2326.53" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="9.23">
  <atv:argument name="frameName" value="topo"/>
 </svg>
 <svg atv:refpx="1189.013" atv:refpy="197.501" height="228.36" id="id_13" transform="matrix(1.1338,0,0,1.2042,0,0)" width="405.71" x="845.828" xlink:href="ObjectTypes.PROJECT.ElementoLinea.Tabla_Energia" y="49.826">
  <atv:argument name="base" prefix="base"/>
 </svg>
 <svg atv:refpx="162.327" atv:refpy="177.469" height="600" id="id_18" transform="matrix(0.4063,0,0,0.5417,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="27.693">
  <atv:argument name="frameName" value="entrada"/>
 </svg>
 <text atv:refpx="603.85" atv:refpy="32.002" fill="#000000" font-family="Arial" font-size="22" font-weight="bold" id="id_0" transform="matrix(1.377,0,0,1.2857,-213.005,-1.4285)" x="569.5" y="30.5">Nombre</text>
 <text atv:refpx="0" atv:refpy="0" fill="#000000" font-family="Arial" font-size="20" id="id_1" transform="matrix(1.377,0,0,1.2857,-213.005,-12.5708)" x="569.5" y="67.5">Clave</text>
 <svg atv:refpx="440.962" atv:refpy="170.936" height="600" id="id_16" transform="matrix(0.2775,0,0,0.5367,0,0)" width="800" x="1189.19" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="18.633">
  <atv:argument name="frameName" value="tanque"/>
  <atv:argument name="base" prefix="base"/>
  <atv:argument name="display" value="ObjectTypes.PROJECT.ElementoLinea.Tanque"/>
 </svg>
 <svg atv:refpx="442.5" atv:refpy="186.8" height="400" id="id_2" transform="matrix(0.5625,0,0,0.975,0,0)" width="400" x="586.667" xlink:href="SYSTEM.LIBRARY.PROJECT.OBJECTDISPLAYS.Advanced.Advanced.highcharts.highcharts_mod" y="5.128">
  <atv:argument name="base" prefix="base"/>
  <atv:argument name="trendName" prefix="base" value=".level_percent"/>
  <atv:argument name="series1series_address" prefix="base" value=".level_percent"/>
  <atv:argument name="series1series_name" value="T{Nivel}"/>
  <atv:argument name="series1series_marker_enabled" value="false"/>
  <atv:argument name="series1series_color" value="#000000"/>
  <atv:argument name="yAxis1yAxis_id" value="level"/>
  <atv:argument name="yAxis1yAxis_title_text" value="Nivel"/>
  <atv:argument name="yAxis1yAxis_min" value="0"/>
  <atv:argument name="xAxisxAxis_timeSpan" value="12"/>
  <atv:argument name="xAxisxAxis_timeSpanUnit" value="hour(s)"/>
  <atv:argument name="xAxisxAxis_labels_enabled" value="false"/>
  <atv:argument name="xAxisxAxis_tickInterval" value="10000000"/>
  <atv:argument name="series1series_lineWidth" value="3"/>
  <atv:argument name="series1series_tooltip_valueSuffix" value="%"/>
  <atv:argument name="series1series_tooltip_valueDecimals" value="0"/>
  <atv:argument name="zoomType" value="xy axis"/>
  <atv:argument name="gshowExportMenu" value="false"/>
  <atv:argument name="yAxis1yAxis_max" value="100"/>
  <atv:argument name="yAxis1yAxis_visible" value="false"/>
  <atv:argument name="yAxis1yAxis_labels_enabled" value="false"/>
  <atv:argument name="xAxisxAxis_lineWidth" value="2"/>
  <atv:argument name="performance_sampling_factor" value="3"/>
  <atv:argument name="gatviseOptions_disableDownSampling" value="false"/>
  <atv:argument name="performance_update_interval" value="3000"/>
  <atv:overwrite id="highchart_label" transform="matrix(1.7778,0,0,1.0256,0,0)" x="-58" y="206"/>
  <atv:overwrite height="388" id="border" transform="matrix(1.7778,0,0,1.0256,0,0)" width="223"/>
  <atv:overwrite height="390" id="id_3" transform="matrix(1.7778,0,0,1.0256,0,0)" width="225"/>
 </svg>
 <svg atv:refpx="442.442" atv:refpy="169.935" height="600" id="id_14" transform="matrix(0.2813,0,0,0.55,0,0)" width="800" x="1173.125" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="9.091">
  <atv:argument name="frameName" value="clickarea"/>
  <atv:argument name="base" prefix="base"/>
  <atv:argument name="display" value="ObjectTypes.PROJECT.ElementoLinea.cliackarea"/>
 </svg>
 <svg atv:refpx="958.858" atv:refpy="600.477" height="600" id="graphicsgroup" transform="matrix(2.4,0,0,0.925,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="367.568">
  <atv:argument name="frameName" value="graficos"/>
  <atv:argument name="isNavigationFrame" value="true"/>
  <atv:argument name="base" prefix="base"/>
 </svg>
 <svg atv:refpx="958.859" atv:refpy="504.975" height="600" id="flowmetergroup" transform="matrix(2.4,0,0,0.5833,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="565.747">
  <atv:argument name="frameName" value="caudalimetros"/>
  <atv:argument name="isNavigationFrame" value="true"/>
 </svg>
 <svg atv:refpx="644.934" atv:refpy="310" height="30" id="id_4" transform="matrix(1.875,0,0,1,0,0)" width="80" x="303.965" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="295">
  <atv:argument name="label" value="T{Mostrar gr치fico}"/>
  <atv:argument name="fontSize" value="16"/>
  <atv:argument name="fontWeight" value="bold"/>
  <atv:argument name="fontWeight2" value="bold"/>
  <atv:overwrite id="id_6" transform="matrix(0.5333,0,0,1,0,0)" width="148"/>
  <atv:overwrite id="button_label_2" transform="matrix(0.5333,0,0,1,0,0)" x="75"/>
  <atv:overwrite id="button_label_1" transform="matrix(0.5333,0,0,1,0,0)" x="75.5"/>
  <atv:overwrite id="button_label" transform="matrix(0.5333,0,0,1,0,0)" x="75.5"/>
  <atv:overwrite id="button_symbol_bottom" transform="matrix(0.32,0,0,0.6,0,0)" x="114.833"/>
  <atv:overwrite id="button_symbol_top" transform="matrix(0.32,0,0,0.6,0,0)" x="114.833"/>
  <atv:overwrite id="button_symbol" transform="matrix(0.5333,0,0,1,0,0)" x="65"/>
  <atv:overwrite id="button_stroke" transform="matrix(0.5333,0,0,1,0,0)" width="146"/>
  <atv:overwrite id="button_bg" transform="matrix(0.5333,0,0,1,0,0)" width="148"/>
  <atv:overwrite id="outer_frame" transform="matrix(0.5333,0,0,1,0,0)" width="150"/>
 </svg>
 <svg atv:refpx="809.998" atv:refpy="310" height="30" id="id_10" transform="matrix(1.875,0,0,1,0,0)" width="80" x="392" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="295">
  <atv:argument name="label" value="T{Recargar p치gina}"/>
  <atv:argument name="fontSize" value="16"/>
  <atv:argument name="fontWeight" value="bold"/>
  <atv:argument name="fontWeight2" value="bold"/>
  <atv:overwrite id="id_6" transform="matrix(0.5333,0,0,1,0,0)" width="148"/>
  <atv:overwrite id="button_label_2" transform="matrix(0.5333,0,0,1,0,0)" x="75"/>
  <atv:overwrite id="button_label_1" transform="matrix(0.5333,0,0,1,0,0)" x="75.5"/>
  <atv:overwrite id="button_label" transform="matrix(0.5333,0,0,1,0,0)" x="75.5"/>
  <atv:overwrite id="button_symbol_bottom" transform="matrix(0.32,0,0,0.6,0,0)" x="114.833"/>
  <atv:overwrite id="button_symbol_top" transform="matrix(0.32,0,0,0.6,0,0)" x="114.833"/>
  <atv:overwrite id="button_symbol" transform="matrix(0.5333,0,0,1,0,0)" x="65"/>
  <atv:overwrite id="button_stroke" transform="matrix(0.5333,0,0,1,0,0)" width="146"/>
  <atv:overwrite id="button_bg" transform="matrix(0.5333,0,0,1,0,0)" width="148"/>
  <atv:overwrite id="outer_frame" transform="matrix(0.5333,0,0,1,0,0)" width="150"/>
 </svg>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[// === FUNCIONES UTILITARIAS ===

function subscribeVisibility(id, variablePath, hideIf = 0) {
    webMI.data.read(variablePath, function(e) {
        if (e.value == hideIf) webMI.gfx.setVisible(id, false);
    });
}

function readAndSetText(id, variablePath) {
    webMI.data.read(variablePath, function(e) {
        webMI.gfx.setText(id, e.value);
    });
}

function readAndOpenDisplay(variablePath, target = "content") {
    webMI.data.read(variablePath, function(e) {
        webMI.display.openDisplay(e.value, webMI.query, target);
    });
}

function getMunicipioDesdeRuta(ruta) {
    const match = ruta.match(/SCADA\.([^.]+)\./);
    if (match && match[1]) {
        return match[1].replace(/_/g, " ");
    }
    return "Sin municipio";
}

// 游댠 NUEVA: Abrir ventana con t칤tulo din치mico
function openWindowWithDynamicTitle(id, variablePath, displayPath, titlePrefix = "", windowOptions = {}) {
    webMI.data.read(variablePath, function(res) {
        const nombre = res.value || "Sin nombre";
        const municipio = getMunicipioDesdeRuta(webMI.query["base"]);
		const titulo = "T{" + titlePrefix + nombre + " - " + municipio + "}";

        webMI.display.openWindow({
            display: displayPath,
            title: titulo,
            query: webMI.query,
            ...windowOptions
        });
    });
}
// === ONLOAD ===
webMI.addOnload(function() {
    webMI.display.openDisplay("SYSTEM.DISPLAYS.ConectividadMain", webMI.query, "tendencias");
});

// === LECTURAS INICIALES ===
readAndSetText("id_0", webMI.query["base"] + ".short_name");
readAndSetText("id_1", webMI.query["base"] + ".sap_name");
readAndSetText("id_5", webMI.query["base"] + ".Responsable");

// === VISIBILIDAD CONDICIONAL ===
subscribeVisibility("id_2", webMI.query["base"] + ".level_percent");
subscribeVisibility("id_16", webMI.query["base"] + ".level_percent");

// === DISPLAY DIN츼MICO DESDE VARIABLES ===
readAndOpenDisplay(webMI.query["base"] + ".circuito", "topo");
readAndOpenDisplay(webMI.query["base"] + ".in_L1", "entrada");

webMI.data.subscribe(webMI.query["base"] + ".caudalimetros_Display", function(e) {
    webMI.display.openDisplay(e.value, webMI.query, "caudalimetros");
});

// === ACTUALIZACI칍N DE PPM CON L칍GICA CONDICIONAL ===
webMI.data.subscribe(webMI.query["base"] + ".ppm", function(e) {
    const id = "id_7";
    if (e.value == 0) {
        webMI.gfx.setVisible(id, false);
    } else {
        webMI.gfx.setText(id, e.value);
    }
});


webMI.addEvent("id_10", "click", function() {
    webMI.display.openDisplay("SYSTEM.DISPLAYS.Circuito.Reservorio", webMI.query, "content");
});

// === NUEVO EVENTO: id_7 con t칤tulo din치mico usando .name ===

webMI.addEvent("id_4", "click", function() {
    openWindowWithDynamicTitle(
        "id_4",
        webMI.query["base"] + ".short_name",
        "SYSTEM.DISPLAYS.Instalacion.Tendencia",
        "Tendencia de ",
        {
            extern: false,
            height: 575,
            width: 1920,
            x: 0,
            y: 430,
            menubar: false,
            modal: false,
            movable: true,
            resizable: true,
            scrollbars: false,
            status: false,
            toolbar: false
        }
    );
});
]]></script>
</svg>
