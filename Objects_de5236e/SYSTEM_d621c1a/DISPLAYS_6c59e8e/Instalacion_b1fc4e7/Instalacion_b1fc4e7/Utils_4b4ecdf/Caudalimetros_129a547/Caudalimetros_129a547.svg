<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="320" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:parameter defaultvalue="5" desc="Líneas por página" name="perPage" valuetype="number"/>
  <atv:parameter defaultvalue="60" desc="Límite duro por seguridad" name="maxTotal" valuetype="number"/>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="false" height="10" width="10"/>
 </metadata>
 <!-- Título -->
 <text atv:refpx="57.5" atv:refpy="17" fill="#333" font-family="Arial" font-size="14" id="hdr" x="12" y="22">Caudalímetros</text>
 <!-- Paginación (centrada en ancho de 1200px) -->
 <svg atv:refpx="560" atv:refpy="290" height="30" id="btnPrev" width="80" x="520" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="287">
  <atv:argument name="label" value="T{◀︎}"/>
 </svg>
 <text atv:refpx="618.5" atv:refpy="300" font-family="Arial" font-size="14" id="pageLabel" x="610" y="305">1/1</text>
 <svg atv:refpx="700" atv:refpy="290" height="30" id="btnNext" width="80" x="660" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="287">
  <atv:argument name="label" value="T{▶︎}"/>
 </svg>
 <!-- LÍNEAS (izq) 1200x50 c/u
       800x600 -> 1200x50 => scaleX=1.5, scaleY=1/12 (0.0833333)
       Y finales: 25, 77, 129, 181, 233  => y_iframe = Yf * 12
  -->
 <svg atv:refpx="600" atv:refpy="50" height="600" id="ln01" transform="matrix(1.5,0,0,0.0833333333,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="300">
  <atv:argument name="frameName" value="ln01"/>
 </svg>
 <svg atv:refpx="600" atv:refpy="102" height="600" id="ln02" transform="matrix(1.5,0,0,0.0833333333,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="924">
  <atv:argument name="frameName" value="ln02"/>
 </svg>
 <svg atv:refpx="600" atv:refpy="154" height="600" id="ln03" transform="matrix(1.5,0,0,0.0833333333,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="1548">
  <atv:argument name="frameName" value="ln03"/>
 </svg>
 <svg atv:refpx="600" atv:refpy="206" height="600" id="ln04" transform="matrix(1.5,0,0,0.0833333333,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="2172">
  <atv:argument name="frameName" value="ln04"/>
 </svg>
 <svg atv:refpx="600" atv:refpy="258" height="600" id="ln05" transform="matrix(1.5,0,0,0.0833333333,0,0)" width="800" x="0" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="2796">
  <atv:argument name="frameName" value="ln05"/>
 </svg>
 <!-- CARD lateral (der) 720x300 -> 800x600 escalado 0.9 x 0.5 -->
 <svg atv:refpx="1563" atv:refpy="160" height="600" id="ca_side" transform="matrix(0.9,0,0,0.5333,0,0)" width="800" x="1336.667" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="0">
  <atv:argument name="frameName" value="ca_side"/>
 </svg>
 <!-- Overlay de debug (arriba-derecha) -->
 <text atv:refpx="1257" atv:refpy="18" fill="#ffffff" font-family="Consolas,monospace" font-size="12" id="dbg_text" visibility="hidden" x="1230" y="22">
  logging…
</text>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[/* === CONFIG === */
var PER_PAGE   = 5;
var MAX_TOTAL  = 60;

var LINE_PATH  = "SYSTEM.DISPLAYS.Caudalimetro.Line";
var CARD_PATH  = "SYSTEM.DISPLAYS.Caudalimetro.Card";

/* === ESTADO === */
var base  = webMI.query.base || "";
var items = [];
var page  = 0;

var LAST_SIG = "", LAST_PAGE = 0;
var ONE_SHOT = true;

var SLOT_ADDRS = Object.create(null);
var SELECTED_ADDR = null;

/* Utils */
function slotId(i){ return "ln" + ("0"+i).slice(-2); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* Abre/actualiza Line en su iframe */
function openLine(slot, address){
  if (!address) return;
  var target = slotId(slot);
  var params = Object.assign({}, webMI.query, { base: address, frameName: target });
  try {
    webMI.display.openDisplay(LINE_PATH, params, target);
    webMI.gfx.setVisible(target, true);
    SLOT_ADDRS[target] = address;
  } catch(e){}
}

/* Abre Card lateral (en el iframe 'ca_side') */
function openCard(address){
  if (!address) return;
  if (SELECTED_ADDR === address) return;
  SELECTED_ADDR = address;
  try {
    webMI.display.openDisplay(
      "SYSTEM.DISPLAYS.Caudalimetro.Card",
      Object.assign({}, webMI.query, { base: address, frameName: "ca_side" }),
      "ca_side"
    );
    webMI.gfx.setVisible("ca_side", true);
  } catch(e){}
}

/* Click en cada iframe de línea -> abre Card */
function bindSlotClicks(){
  for (var i=1; i<=PER_PAGE; i++){
    (function(id){
      try {
        webMI.addEvent(id, "click", function(){
          var addr = SLOT_ADDRS[id];
          if (addr) openCard(addr);
        });
      } catch(e){}
    })(slotId(i));
  }
}

/* Render */
function render(){
  SLOT_ADDRS = Object.create(null);

  var total = Math.min(items.length, MAX_TOTAL);
  var totalPages = Math.max(1, Math.ceil((total || 1)/PER_PAGE));
  page = clamp(page, 0, totalPages-1);

  try { webMI.gfx.setText("pageLabel", total ? ((page+1)+"/"+totalPages) : "0/0"); } catch(e){}

  var prevEnabled = page > 0;
  var nextEnabled = (total > PER_PAGE) && (page < totalPages - 1);
  try {
    webMI.gfx.setVisible("btnPrev", prevEnabled);
    webMI.gfx.setVisible("btnNext", nextEnabled);
  } catch(e){}

  if (!total){
    for (var k=1; k<=PER_PAGE; k++) try{ webMI.gfx.setVisible(slotId(k), false); }catch(e){}
    try{ webMI.gfx.setVisible("ca_side", false); }catch(e){}
    return;
  }

  var start = page * PER_PAGE;
  var end   = Math.min(start + PER_PAGE, total);
  var slot  = 1;
  var firstAddr = null;

  for (var i=start; i<end; i++){
    var addr = items[i] && items[i].address;
    if (addr){
      if (!firstAddr) firstAddr = addr;
      openLine(slot, addr);
      slot++;
    }
  }
  for (; slot<=PER_PAGE; slot++) try{ webMI.gfx.setVisible(slotId(slot), false); }catch(e){}

  // Si la card no corresponde a esta página, centra la primera visible
  var keep = false;
  if (SELECTED_ADDR){
    for (var j=start; j<end; j++){
      if ((items[j] && items[j].address) === SELECTED_ADDR){ keep = true; break; }
    }
  }
  if (!keep) openCard(firstAddr);
}

/* Listar Caudalímetros */
function loadFromMethod(){
  if (!base) return;
  webMI.data.call("ListarEquipos", {
    startAddress: base,
    endLevel: "3",
    levelMode: "exact",
    recursive: "true",
    max: "0",
    includeStartAddress: "false",
    filterTypeName: "Caudalimetro",
    debug: "false"
  }, function(ret){
    var newItems = [];
    if (ret && Array.isArray(ret.items)){
      newItems = ret.items.map(function(n){
        var addr = String((n && n.address) || "");
        var i = addr.indexOf("s="); if (i>=0) addr = addr.slice(i+2);
        return { address: addr, name: (n && n.name) || "" };
      }).filter(function(it){ return !!it.address; });
    }
    applyNewItems(newItems);
  });
}

function applyNewItems(newItems){
  var newSig = (newItems||[]).map(function(it){ return it.address; }).join("|");

  if (ONE_SHOT){
    items = newItems; LAST_SIG = newSig;
    render();
    return;
  }
  if (newSig !== LAST_SIG){
    items = newItems; LAST_SIG = newSig;
    render();
  } else if (LAST_PAGE !== page){
    render();
  }
  LAST_PAGE = page;
}

/* Navigation */
try {
  webMI.addEvent("btnPrev","click", function(){
    var total = Math.min(items.length, MAX_TOTAL);
    if (page > 0){ page--; render(); }
  });
  webMI.addEvent("btnNext","click", function(){
    var total = Math.min(items.length, MAX_TOTAL);
    var totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    if (page < totalPages - 1){ page++; render(); }
  });
} catch(e){}

/* Arranque */
bindSlotClicks();
loadFromMethod();
]]></script>
</svg>
