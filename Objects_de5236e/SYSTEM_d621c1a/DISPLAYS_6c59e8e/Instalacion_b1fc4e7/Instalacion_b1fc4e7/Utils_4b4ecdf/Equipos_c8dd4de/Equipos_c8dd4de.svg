<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="245" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="false" height="10" width="10"/>
 </metadata>
 <!-- Encabezado -->
 <text atv:refpx="37" atv:refpy="17" fill="#333" font-family="Arial" font-size="14" id="hdr" x="12" y="22">Equipos</text>
 <!-- 6 SLOTS (iframe 800x600 escalado a 300x180)  scaleX=0.375, scaleY=0.3 -->
 <svg atv:refpx="160" atv:refpy="118" height="600" id="eq01" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="26.667" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq01"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <svg atv:refpx="480" atv:refpy="118" height="600" id="eq02" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="880" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq02"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <svg atv:refpx="800" atv:refpy="118" height="600" id="eq03" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="1733.333" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq03"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <svg atv:refpx="1120" atv:refpy="118" height="600" id="eq04" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="2586.667" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq04"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <svg atv:refpx="1440" atv:refpy="118" height="600" id="eq05" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="3440" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq05"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <svg atv:refpx="1760" atv:refpy="118" height="600" id="eq06" transform="matrix(0.375,0,0,0.3,0,0)" width="800" x="4293.333" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.hmi.iframe" y="93.333">
  <atv:argument name="frameName" value="eq06"/>
  <atv:argument name="isNavigationFrame" value="false"/>
  <atv:argument name="isDefault" value="true"/>
 </svg>
 <!-- Paginación -->
 <svg atv:refpx="50" atv:refpy="225" height="30" id="btnPrev" width="80" x="10" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="210">
  <atv:argument name="label" value="T{◀︎}"/>
 </svg>
 <text atv:refpx="113.5" atv:refpy="221" font-family="Arial" font-size="14" id="pageLabel" x="105" y="226">1/1</text>
 <svg atv:refpx="200" atv:refpy="225" height="30" id="btnNext" width="80" x="160" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="210">
  <atv:argument name="label" value="T{▶︎}"/>
 </svg>
 <!-- ================= SCRIPT ================= -->
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[
/* === CONFIG === */
var PER_PAGE     = 6;
var MAX_TOTAL    = 17;
var DISPLAY_PATH = "SYSTEM.DISPLAYS.Equipos.Indicador_Bomba";

/* === ESTADO / CONTROL === */
var base  = webMI.query.base || "AGENT.OBJECTS.Equipos";
var items = [];      // [{address, name}]
var page  = 0;

var LAST_SIG = "", LAST_PAGE = 0;
var ONE_SHOT = true;

// slotId -> address visible en la página actual
var SLOT_ADDRS = Object.create(null);

function slotId(i){ return "eq" + ("0"+i).slice(-2); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

/* Dblclick: abre display hijo a pantalla grande */
function bindSlotDoubleClicks() {
  for (var i = 1; i <= PER_PAGE; i++) {
    (function(id){
      try {
        webMI.addEvent(id, "dblclick", function(){
          var addr = SLOT_ADDRS[id];
          if (!addr) return;
          try {
            webMI.display.openWindow(
              DISPLAY_PATH,
              { base: addr, frameName: id },
              { width: 1280, height: 800, resizable: true, scrollbars: true, modal: false }
            );
          } catch(e){}
        });
      } catch(e){}
    })(slotId(i));
  }
}

/* Abre/actualiza un slot */
function openCard(slot, address){
  if (!address) return;
  var target = slotId(slot);
  var params = Object.assign({}, webMI.query, {
    base: address,
    frameName: target
  });
  try {
    webMI.display.openDisplay(DISPLAY_PATH, params, target);
    webMI.gfx.setVisible(target, true);
    SLOT_ADDRS[target] = address;
  } catch(e){}
}

/* Render de página */
function render(){
  SLOT_ADDRS = Object.create(null);

  var total = Math.min(items.length, MAX_TOTAL);
  var totalPages = Math.max(1, Math.ceil((total || 1)/PER_PAGE));
  page = clamp(page, 0, totalPages-1);

  try { webMI.gfx.setText("pageLabel", total ? ((page+1)+"/"+totalPages) : "0/0"); } catch(e){}

  var prevEnabled = page > 0;
  var nextEnabled = (total > PER_PAGE) && (page < totalPages - 1);
  try {
    webMI.gfx.setVisible("btnPrev", prevEnabled);
    webMI.gfx.setVisible("btnNext", nextEnabled);
  } catch(e){}

  if (!total){
    for (var k=1; k<=PER_PAGE; k++) try{ webMI.gfx.setVisible(slotId(k), false); }catch(e){}
    return;
  }

  var start = page * PER_PAGE;
  var end   = Math.min(start + PER_PAGE, total);
  var slot  = 1;

  for (var i=start; i<end; i++){
    var addr = items[i] && items[i].address;
    if (addr){
      openCard(slot, addr);
      slot++;
    }
  }
  for (; slot<=PER_PAGE; slot++) try{ webMI.gfx.setVisible(slotId(slot), false); }catch(e){}
}

/* Carga por método */
function loadFromMethod(){
  webMI.data.call("ListarEquipos", {
    startAddress: base,
    endLevel: "3",
    levelMode: "exact",
    recursive: "true",
    max: "0",
    includeStartAddress: "false",
    filterTypeName: "Bomba",
    debug: "false"
  }, function(ret){
    var newItems = [];
    if (ret && Array.isArray(ret.items)){
      newItems = ret.items.map(function(n){
        var addr = String((n && n.address) || "");
        var i = addr.indexOf("s="); if (i>=0) addr = addr.slice(i+2);
        return { address: addr, name: (n && n.name) || "" };
      }).filter(function(it){ return !!it.address; });
    }
    applyNewItems(newItems);
  });
}

/* Aplica items */
function applyNewItems(newItems){
  var newSig = (newItems||[]).map(function(it){ return it.address; }).join("|");

  if (ONE_SHOT){
    items = newItems; LAST_SIG = newSig;
    render();
    return;
  }
  if (newSig !== LAST_SIG){
    items = newItems; LAST_SIG = newSig;
    render();
  } else if (LAST_PAGE !== page){
    render();
  }
  LAST_PAGE = page;
}

/* Navegación */
try {
  webMI.addEvent("btnPrev","click", function(){
    var total = Math.min(items.length, MAX_TOTAL);
    if (page > 0){ page--; render(); }
  });
  webMI.addEvent("btnNext","click", function(){
    var total = Math.min(items.length, MAX_TOTAL);
    var totalPages = Math.max(1, Math.ceil(total / PER_PAGE));
    if (page < totalPages - 1){ page++; render(); }
  });
} catch(e){}

/* === API pública para setear base/items === */
window.UtilEquipos_setBase = function(newBase){
  if (typeof newBase === "string" && newBase){
    base = newBase;
    loadFromMethod();
  }
};
window.UtilEquipos_setItems = function(addressArray){
  if (!Array.isArray(addressArray)) return;
  var mapped = addressArray
    .filter(function(x){ return typeof x === "string" && x; })
    .map(function(addr){ return { address: addr, name: "" }; });
  applyNewItems(mapped);
};
window.UtilEquipos_openPage = function(p){
  if (typeof p === "number"){
    page = Math.max(0, Math.floor(p));
    render();
  }
};
window.UtilEquipos_refresh = function(){ render(); };

/* Arranque */
(function init(){
  bindSlotDoubleClicks();
  loadFromMethod();
})();
 ]]></script>
</svg>
