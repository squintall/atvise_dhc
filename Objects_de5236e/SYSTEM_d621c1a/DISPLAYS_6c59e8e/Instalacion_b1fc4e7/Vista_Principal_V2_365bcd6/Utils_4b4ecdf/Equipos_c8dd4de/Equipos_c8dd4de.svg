<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="245" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="false" height="10" width="10"/>
 </metadata>
 <!-- Contenedor HTML (XHTML dentro de foreignObject) -->
 <foreignObject height="245" id="fo_root" requiredExtensions="http://www.w3.org/1999/xhtml" width="1920" x="0" y="0">
  <div id="fo_root_host" style="width:100%;height:100%;overflow-y:auto;display:flex;flex-wrap:wrap;align-content:flex-start;gap:20px;padding:10px;" xmlns="http://www.w3.org/1999/xhtml"/>
 </foreignObject>
 <!-- =============================================================== -->
 <!-- =============== UNICO SCRIPT (TODO EN CDATA) ================== -->
 <!-- =============================================================== -->
 <script atv:desc="" atv:href="SYSTEM.LIBRARY.PROJECT.DISPLAYSCRIPTS.equipos.Utils" atv:name="Utils" atv:type="text/ecmascript"/>
 <script atv:desc="" atv:href="SYSTEM.LIBRARY.PROJECT.DISPLAYSCRIPTS.equipos.Render" atv:name="Render" atv:type="text/ecmascript"/>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[
/* ===================================================================
   MAIN (orquestador)
   =================================================================== */
if (typeof EquiposMain === 'undefined') { var EquiposMain = {}; }
(function(){
  var host = null;
  var base = (webMI && webMI.query && webMI.query.base) ? webMI.query.base : 'AGENT.OBJECTS.Equipos';

  function loadFromMethod(){
    // Ajusta filterTypeName si tu metodo espera el FQN del ObjectType
    webMI.data.call('ListarEquipos', {
      startAddress: base, endLevel: '3', levelMode: 'exact', recursive: 'true', max: '0',
      includeStartAddress: 'false', filterTypeName: 'Bomba', debug: 'false'
    }, function(ret){
      var arr = [];
      if (ret && Array.isArray(ret.items)) {
        for (var i=0;i<ret.items.length;i++){
          var n = ret.items[i];
          var addr = String((n && n.address) || '');
          var k = addr.indexOf('s=');
          if (k >= 0) addr = addr.slice(k+2);
          if (addr) arr.push({ address: addr, name: (n && n.name) || '' });
        }
      }
      EquiposList.updateItems(arr);
    });
  }

  function init(){
    host = document.getElementById('fo_root_host');
    if (!host) return;
    EquiposList.mount(host);
    loadFromMethod();

    // API publica para displays externos
    window.UtilEquipos_setBase = function(newBase){
      if (typeof newBase === 'string' && newBase) { base = newBase; loadFromMethod(); }
    };
    window.UtilEquipos_setItems = function(addressArray){
      if (!Array.isArray(addressArray)) return;
      var mapped = [];
      for (var i=0;i<addressArray.length;i++){
        var a = addressArray[i];
        if (typeof a === 'string' && a) mapped.push({ address: a, name: '' });
      }
      EquiposList.updateItems(mapped);
    };
    window.UtilEquipos_refresh = function(){ loadFromMethod(); };
  }

  if (webMI && typeof webMI.addOnload === 'function') { webMI.addOnload(init); }
  else { init(); }
})();

  ]]></script>
</svg>
