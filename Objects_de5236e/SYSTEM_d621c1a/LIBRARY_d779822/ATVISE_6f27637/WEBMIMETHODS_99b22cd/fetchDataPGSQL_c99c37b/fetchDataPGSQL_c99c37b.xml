<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <owner>root</owner>
    <runcontext>caller</runcontext>
  </metadata>
  <parameter name="Parameters" type="http" trigger="false" relative="false" value=""/>
  <code><![CDATA[

function fetchDataPGSQL(Parameters) {
    var query = Parameters.query; // Obtener la consulta SQL desde los parámetros

    var o = new ODBCClient();
    o.source = "DSN=PostgreSQL;UID=vnode;PWD=vnode"; // Configura tu DSN, usuario y contraseña
    
    if (o.open()) {
        try {
            // Ejecutar la consulta proporcionada
            var result = o.query(query);

            if (!result || result.length === 0) {
                throw new Error("No se obtuvieron datos.");
            }

            o.close();

            // Formatear los resultados como JSON
            var formattedResult = result.map(row => ({
                id: row[0],
                fecha_hora: row[1],
                portillo_l1: row[2],
                portillo_l2: row[3],
                portillo_l3: row[4],
                portillo_l4: row[5]
            }));
            
            return { result: formattedResult };
        } catch (error) {
            o.close();
            console.error("Error al obtener los datos:", error.message);
            return { error: error.message };
        }
    } else {
        return { error: "No se pudo conectar a la base de datos." };
    }
}
]]></code>
</script>
