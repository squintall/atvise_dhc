<?xml version="1.0" encoding="UTF-8"?>
<script>
  <metadata>
    <priority>0</priority>
    <owner>root</owner>
    <runcontext>caller</runcontext>
  </metadata>
  <parameter name="Parameters" type="http" trigger="false" relative="false" value=""/>
  <code><![CDATA[var request = Parameters.request.getvalues;

var data = FetchDataFromDB(request);

return data;

function FetchDataFromDB(request) {
    var query = request.query; // Obtener la consulta SQL desde el parámetro enviado por el frontend
    
    var o = new ODBCClient();
    o.source = "DSN=PostgreSQL;UID=vnode;PWD=vnode"; // Configura tu fuente DSN, usuario y contraseña
    
    if (o.open()) {
        try {
            // Ejecuta la consulta SQL
            var result = o.query(query);
            console.log(result);
            if (!result || result.length === 0) {
                throw new Error("No se obtuvieron datos.");
            }

            o.close();

            // Formatea los resultados como JSON, eliminando el campo 'id'
            var formattedResult = result.map(row => ({
                fecha_hora: row[0],
                portillo_l1: row[1],
                portillo_l2: row[2],
                portillo_l3: row[3],
                portillo_l4: row[4]
            }));
            console.log(formattedResult);
            return { result: formattedResult };
        } catch (error) {
            o.close();
            console.error("Error al obtener los datos:", error.message);
            return { error: error.message };
        }
    } else {
        return { error: "No se pudo conectar a la base de datos." };
    }
}
]]></code>
</script>
