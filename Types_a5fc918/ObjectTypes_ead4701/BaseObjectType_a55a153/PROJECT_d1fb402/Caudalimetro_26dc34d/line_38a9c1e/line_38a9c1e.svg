<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<svg height="50" version="1.2" width="1920" xmlns="http://www.w3.org/2000/svg" xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:xlink="http://www.w3.org/1999/xlink">
 <defs/>
 <metadata>
  <atv:gridconfig enabled="false" gridstyle="lines" height="20" width="20"/>
  <atv:snapconfig enabled="true" height="1" width="1"/>
 </metadata>
 <rect atv:refpx="169" atv:refpy="25.5" fill="#ffffff" height="47" id="id_11" stroke="#000000" stroke-width="2" width="336" x="1" y="2"/>
 <rect atv:refpx="1128.5" atv:refpy="25" fill="#ffffff" height="48" id="id_1" stroke="#000000" stroke-width="2" width="1581" x="338" y="1"/>
 <rect atv:refpx="1969.682" atv:refpy="38.329" fill="#d5d5d5" height="13.812" id="id_0" stroke="#000000" stroke-opacity="0" stroke-width="2.15" width="157.364" x="1742" y="18.188"/>
 <polygon atv:refpx="1254.428" atv:refpy="24" fill="#d5d5d5" id="id_3" points="1899,30.333 1899,41 1918.97,25 1899,8.998 1899,8.998" stroke="#000000" stroke-opacity="0" stroke-width="2.15"/>
 <rect atv:refpx="497.592" atv:refpy="25.049" fill="#ffffff" height="48.1" id="id_13" stroke="#000000" stroke-width="2" width="411" x="1136" y="1"/>
 <rect atv:refpx="0" atv:refpy="0" fill="#e8e8e8" height="44.026" id="id_12" stroke="#000000" stroke-opacity="0" stroke-width="2" width="106" x="1248" y="3.521"/>
 <text atv:refpx="1312.267" atv:refpy="32.615" fill="#000000" font-family="Arial" font-size="22" font-weight="bold" id="id_38" text-anchor="end" x="1325.767" y="45.115">Q</text>
 <text atv:refpx="1339.386" atv:refpy="38.921" fill="#000000" font-family="Arial" font-size="18" font-weight="bold" id="id_39" text-anchor="end" x="1348.886" y="45.421">l/s</text>
 <text atv:refpx="1172.286" atv:refpy="40.615" fill="#000000" font-family="Arial" font-size="22" font-weight="bold" id="id_47" text-anchor="end" x="1180.533" y="45.115">P</text>
 <text atv:refpx="1240.742" atv:refpy="40.921" fill="#000000" font-family="Arial" font-size="18" font-weight="bold" id="id_49" text-anchor="start" x="1181.231" y="45.421">kg/cm2</text>
 <text atv:refpx="43" atv:refpy="0" fill="#000000" font-family="Arial" font-size="22" font-weight="bold" id="id_56" text-anchor="end" x="1512.931" y="45.115">Vd</text>
 <text atv:refpx="1542.262" atv:refpy="40.921" fill="#000000" font-family="Arial" font-size="18" font-weight="bold" id="id_57" text-anchor="start" x="1515.932" y="45.421">m3</text>
 <text atv:refpx="140.818" atv:refpy="31" fill="#000000" font-family="Arial" font-size="24" id="id_6" text-anchor="start" x="130.5" y="35.5">NL</text>
 <text atv:refpx="84.425" atv:refpy="31" fill="#000000" font-family="Arial" font-size="24" font-weight="bold" id="id_7" text-anchor="end" x="93.5" y="35.5">D</text>
 <line atv:refpx="1016.5" atv:refpy="23.5" id="id_10" stroke="#000000" stroke-width="2" x1="1135" x2="1135" y1="48" y2="1"/>
 <text atv:refpx="107.326" atv:refpy="31" fill="#000000" font-family="Arial" font-size="24" font-weight="bold" id="id_14" text-anchor="start" x="96.5" y="35.5">"</text>
 <rect atv:refpx="309.953" atv:refpy="29.015" fill="#e8e8e8" height="44.026" id="id_2" stroke="#000000" stroke-opacity="0" stroke-width="2" width="265" x="1548" y="4"/>
 <text atv:refpx="1220" atv:refpy="16.5" fill="#000000" font-family="Arial" font-size="12" font-weight="bold" id="id_5" text-anchor="start" x="1198.5" y="21">Presión</text>
 <text atv:refpx="1329.886" atv:refpy="16.5" fill="#000000" font-family="Arial" font-size="12" font-weight="bold" id="id_15" text-anchor="end" x="1348.886" y="21">Caudal</text>
 <text atv:refpx="1509.932" atv:refpy="16.5" fill="#000000" font-family="Arial" font-size="12" font-weight="bold" id="id_16" text-anchor="end" x="1541.932" y="21">Producción</text>
 <text atv:refpx="1764.5" atv:refpy="17.125" fill="#000000" font-family="Arial" font-size="12" font-weight="bold" id="id_17" text-anchor="end" x="1810.5" y="21.625">Producción total</text>
 <text atv:refpx="1765.487" atv:refpy="41.24" fill="#000000" font-family="Arial" font-size="22" font-weight="bold" id="id_18" text-anchor="end" x="1781.5" y="45.74">Vd</text>
 <text atv:refpx="1810.83" atv:refpy="41.546" fill="#000000" font-family="Arial" font-size="18" font-weight="bold" id="id_19" text-anchor="start" x="1784.5" y="46.046">m3</text>
 <rect atv:refpx="991.5" atv:refpy="-194.5" fill="#e8e8e8" fill-opacity="0" height="45" id="id_21" stroke="#000000" stroke-opacity="0" stroke-width="2" width="103" x="1248" y="-217"/>
 <rect atv:refpx="-326.251" atv:refpy="26" fill="#e8e8e8" fill-opacity="0" height="44" id="id_22" stroke="#000000" stroke-opacity="0" stroke-width="2" width="261" x="1549" y="4"/>
 <svg atv:refpx="25" atv:refpy="25" height="30" id="btn_options" transform="matrix(0.375,0,0,1,0,0)" width="80" x="34.667" xlink:href="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Advanced.button" y="10">
  <atv:argument name="label" value="T{Options}"/>
  <atv:argument name="fontSize" value="8"/>
  <atv:argument name="visibilitySymbol" value="inherit"/>
  <atv:argument name="visibilityLabel" value="hidden"/>
  <atv:argument name="symbol" value="SYSTEM.LIBRARY.ATVISE.OBJECTDISPLAYS.Symbols.20x20.gears"/>
  <atv:argument name="right" prefix="options_right"/>
  <atv:argument name="activeNode" prefix="options_activeNode"/>
  <atv:argument name="activeValue" prefix="options_activeValue"/>
  <atv:argument name="tooltip" value="T{Open options}"/>
  <atv:overwrite id="id_2" transform="matrix(2.6667,0,0,1,0,0)" width="24.5"/>
  <atv:overwrite id="id_0" transform="matrix(2.6667,0,0,1,0,0)" width="29.5"/>
  <atv:argument name="tabIndex" value="4"/>
  <atv:overwrite id="id_6" transform="matrix(2.6667,0,0,1,0,0)" width="28"/>
  <atv:overwrite id="button_label_2" transform="matrix(2.6667,0,0,1,0,0)" x="15"/>
  <atv:overwrite id="button_label_1" transform="matrix(2.6667,0,0,1,0,0)" x="15.5"/>
  <atv:overwrite id="button_label" transform="matrix(2.6667,0,0,1,0,0)" x="15.5"/>
  <atv:overwrite id="button_symbol_bottom" transform="matrix(1.6,0,0,0.6,0,0)" x="14.833"/>
  <atv:overwrite id="button_symbol_top" transform="matrix(1.6,0,0,0.6,0,0)" x="14.833"/>
  <atv:overwrite id="button_symbol" transform="matrix(2.6667,0,0,1,0,0)" x="5"/>
  <atv:overwrite id="button_stroke" transform="matrix(2.6667,0,0,1,0,0)" width="26"/>
  <atv:overwrite id="button_bg" transform="matrix(2.6667,0,0,1,0,0)" width="28"/>
  <atv:overwrite id="outer_frame" transform="matrix(2.6667,0,0,1,0,0)" width="30"/>
 </svg>
 <rect atv:refpx="-10.125" atv:refpy="26" fill="#e8e8e8" fill-opacity="0" height="44" id="id_4" stroke="#000000" stroke-opacity="0" stroke-width="2" width="190" x="1355" y="4"/>
 <rect atv:refpx="1302" atv:refpy="25" fill="#000000" fill-opacity="0" height="48" id="id_8" stroke="#0000ff" stroke-opacity="0" stroke-width="2" width="104" x="1250" y="1"/>
 <rect atv:refpx="1192" atv:refpy="25" fill="#000000" fill-opacity="0" height="48" id="id_9" stroke="#0000ff" stroke-opacity="0" stroke-width="2" width="110" x="1137" y="1"/>
 <script atv:desc="" atv:name="" type="text/ecmascript"><![CDATA[// === FUNCIONES UTILITARIAS ===

// Formatea números según configuración regional
function formatNumber(value, digits = 1) {
    return new Intl.NumberFormat('es-MX', { maximumFractionDigits: digits }).format(value);
}

// Formatea fecha desde timestamp
function formatDate(timestamp) {
    const date = new Date(timestamp);
    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
    return new Intl.DateTimeFormat('es-MX', options).format(date);
}

// Suscribe a variable y actualiza texto con formato opcional
function subscribeText(id, variablePath, formatter = val => val) {
    webMI.data.subscribe(variablePath, function(e) {
        webMI.gfx.setText(id, formatter(e.value));
    });
}

// Suscribe a variable y cambia color basado en valor y estado
function subscribeFill(id, variablePath, threshold = 1, colorOn = "#2c99d8", colorOff = "#d5d5d5") {
    webMI.data.subscribe(variablePath, function(e) {
        const { status, value } = e;
        const color = (status === 0 && value > threshold) ? colorOn : colorOff;
        webMI.gfx.setFill(id, color);
    });
}

// Crea un evento para abrir una ventana
function addWindowEvent(id, displayPath, options = {}, logInfo = null) {
    webMI.addEvent(id, "click", function() {
        webMI.display.openWindow({
            display: displayPath,
            query: webMI.query,
            ...options
        });

        if (logInfo) {
            webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.WriteLog", {
                group: logInfo.group,
                id,
                label: webMI.query["base"],
                message: logInfo.message,
                subgroup: logInfo.subgroup
            });
        }
    });
}

// === SUSCRIPCIONES ===
subscribeText("id_47", webMI.query["base"] + ".current_pressure", val => webMI.sprintf("%.2f", val));
subscribeText("id_56", webMI.query["base"] + ".current_daily_volume", val => formatNumber(val));
subscribeText("id_38", webMI.query["base"] + ".current_flow", val => webMI.sprintf("%.1f", val));
subscribeText("id_6", webMI.query["base"] + ".name");
subscribeText("id_7", webMI.query["base"] + ".diameter");
subscribeText("id_18", webMI.query["base"] + ".current_total_volume", val => formatNumber(val));

webMI.data.subscribe(webMI.query["base"] + ".current_daily_volume", function(e) {
    const id = "id_16";
    webMI.gfx.setText(id, "Producción: " + formatDate(e.timestamp));
});

subscribeFill("id_3", webMI.query["base"] + ".current_flow");
subscribeFill("id_0", webMI.query["base"] + ".current_flow");

// === EVENTOS DE VENTANA Y PANTALLA ===

addWindowEvent("id_7", "SYSTEM.DISPLAYS.Caudalimetro.change_diameter", {
    height: 100, width: 300, modal: true, title: "T{Editar diámetro}",
    resizable: false, movable: false, menubar: false, scrollbars: false, toolbar: false, status: false, x: 0, y: 0
});

addWindowEvent("id_22", "SYSTEM.DISPLAYS.Caudalimetro.totalizer_options", {
    height: 950, width: 1700, modal: true, title: "T{Acumulado de caudalímetro}"
}, {
    group: "Consulta",
    message: "Consulta de históricos del totalizador",
    subgroup: "Caudalimetros"
});

addWindowEvent("btn_options", "SYSTEM.DISPLAYS.Caudalimetro.change_pressure", {
    height: 220, width: 1280, modal: false, title: "T{Configurar horarios/presiones}"
}, {
    group: "Manipulacion",
    message: "Se ha abierto el menú de cambio de presión",
    subgroup: "Caudalimetros"
});

addWindowEvent("id_4", "SYSTEM.DISPLAYS.Caudalimetro.daily_prod_table", {
    height: 920, width: 1700, modal: true, title: "T{Acumulado diario caudalímetro}"
}, {
    group: "Consulta",
    message: "Consulta de acumulado diario",
    subgroup: "Caudalimetros"
});

addWindowEvent("id_8", "SYSTEM.DISPLAYS.Caudalimetro.graph_caudales", {
    height: 570, width: 1920, modal: true, title: "T{Caudal}"
}, {
    group: "Consulta",
    message: "Consulta de gráfica de caudal",
    subgroup: "Caudalimetros"
});

addWindowEvent("id_9", "SYSTEM.DISPLAYS.Caudalimetro.graph_presiones", {
    height: 570, width: 1920, modal: true, title: "T{Presión}"
}, {
    group: "Consulta",
    message: "Consulta de gráfica de presión",
    subgroup: "Caudalimetros"
});
]]></script>
</svg>
